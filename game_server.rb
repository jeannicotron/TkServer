require 'rubygems'
require 'pp'
require 'eventmachine'
require 'base64'

# Database setup
require 'active_record'
require 'db/config.rb'
Dir[File.dirname(__FILE__) + '/db/models/*.rb'].each {|file| require file }

# Require libs & helpers
Dir[File.dirname(__FILE__) + '/libs/*.rb'].each {|file| require file }
Dir[File.dirname(__FILE__) + '/models/*.rb'].each {|file| require file }

HOST = '192.168.1.2'
PORT = 2035

# Users
$USERS = {} 

class TkGameServer < EventMachine::Connection
  include TkGame
  attr_accessor :user
  
  def initialize
    @user = nil
  end
  
  def unbind
    puts "A user disconnected"
    $USERS.delete(@user)
  end
  
  def post_init
    puts "A user connected"
    #6 0 0 -- client version?
    send_data("\xAA\x00\x05\x1E\x00\x48\x65\x78")
    
    # Routine login packets
    send_data("\xAA\x00\x04\x20\x01\x5F\x56")
    
    # This is the id of the logged in player, it will identify let the game know which one is you
    send_data("\xAA\x00\x0E\x05\x03\x4D\xB3\x18\x30\x6D\x4A\x6D\x62\x2D\x4C\x67\x7A")
    
    # My legend and informations
    send_data("\xAA\x00\xB1\x39\x02\x2F\x67\x7A\x6D\x6C\x4B\x6C\x61\x2C\x4D\x67\x50\x6B\x3D\x2F\x0C\x13\x4C\x22\x13\x7A\x6D\x6C\x4B\x6C\x61\x2C\x4F\x64\x79\x6E\x6F\x48\x6F\x62\x2F\x48\x63\x7E\x69\x68\x4F\x68\x65\x28\x49\x62\x7F\x68\x69\x4E\x69\x64\x29\x4A\x61\x7C\x6B\x6A\x4D\x6A\x67\x2A\x4B\x60\x7D\x6A\x6B\x4C\x6B\x66\x2B\x44\x6F\x72\x65\x64\x43\x64\x69\x24\x45\x6E\x73\x64\x65\x42\x65\x68\x25\x46\x6D\x70\x67\x66\x41\x66\x6B\x26\x47\x6C\x71\x66\x67\x40\x67\x6A\x27\x40\x6B\x76\x61\x60\x47\x60\x6D\x20\x41\x6A\x77\x60\x61\x46\x61\x6C\x21\x42\x69\x74\x63\x62\x45\x62\x6F\x22\x43\x68\x75\x62\x63\x44\x63\x6E\x23\x5C\x77\x6A\x7D\x7D\x5B\xFC\x66\x7E\x32\x04\x05\x5C\x14\x34\x5D\x38\x44\x2B\x19\x48\x4C\x4F\x75\x5E\x24\x57\x31\x00\x0C\x0C")
    
    # Map name
    send_data("\xAA\x00\x1B\x15\x04\x5B\xA7\x7C\x64\x6A\x42\x6F\x67\x24\x12\x01\x1E\x02\x0A\x29\x4C\x15\x0B\x20\x0C\x0B\x1A\x0D\x4F\x80")
    
    #send_data("\xAA\x00\x10\x19\x05\x4A\x65\x7E\xEC\x68\xCA\x0F\x64\x2B\x48\x61\x7C\x6B\x6A")
  
    # Coordinates
    # This packet has my coordinates for some reason
    #send_data("\xAA\x00\x0A\x04\x06\x48\x62\x7E\x6C\x68\x4D\x68\x60")
    
    # objects on the ground
    #send_data("\xAA\x00\x13\x07\x07\x49\x63\x7F\x65\x69\x46\x65\x64\x29\x54\x80\xFF\x8C\x6C\x4E\x68\x65")
    
    #send_data("\xAA\x00\x03\x1F\x08\x46")

    #send_data("\xAA\x00\x05\x63\x09\x45\x6C\x71")


    #send_data("\xAA\x00\x3C\x08\x0A\x3C\x6F\x72\x65\x64\x42\x64\x69\x24\x76\x6E\x73\x64\x44\x41\x66\x6B\x26\x45\x6D\x70\x04\xB9\xDD\x39\x6B\x26\x47\x6C\x71\x66\x67\x73\x67\x6A\x27\x61\x6B\x76\x61\x61\x47\x60\x6D\x20\x41\x6A\x77\x60\x61\x46\x61\x6D\x21\x42\xDA\x49\x63")

    #send_data("\xAA\x00\x03\x58\x0B\x45")
   
    # Thats me
    #send_data("\xAA\x00\xBC\x30\x0D\x43\x6C\x75\x62\x7C\x6E\x63\x6F\x23\x42\x69\x74\x63\x62\x45\x62\x6F\x22\x40\x6A\x76\x60\xC2\x1F\x0E\x19\x01\x33\x07\x19\x16\x0C\x3E\x40\x1A\x41\x2B\x07\x51\x07\x09\x24\x47\x1E\x4F\x23\x4D\x07\x08\x14\x2D\x02\x4B\x55\x32\x07\x01\x08\x16\x62\x04\x1A\x4A\x31\x01\x16\x45\x1D\x2C\x11\x47\x04\x12\x0F\x08\x18\x4B\x29\x12\x03\x58\x6A\x15\x0E\x12\x4A\x39\x05\x47\x4C\x26\x01\x0A\x1B\x49\x2F\x07\x00\x09\x29\x10\x5E\x10\x07\x3A\x48\x09\x47\x20\x0F\x59\x1B\x1F\x68\x16\x0D\x5A\x63\x06\x1A\x16\x0A\x27\x06\x4E\x5A\x22\x13\x5B\x0D\x1F\x2F\x4D\x09\x43\x6C\x06\x5A\x1E\x18\x39\x0D\x0F\x4B\x36\x58\x07\x17\x17\x7A\x53\x56\x1B\x11\x15\x0D\x10\x19\x75\x1C\x1A\x4A\x25\x5A\x13\x1F\x51\x35\x1E\x12\x45\x39\x15\x13\x14\x50\x23\x1F\x5D\x42\x32\x1D\x05\x58\x5E\x79")
    #send_data("\xAA\x00\x03\x49\x0E\x40\xAA\x00\x03\x6A\x0F\x40\xAA\x00\x17\x08\x10\x46\x75\x68\x7F\x7F\x59\x7E\x73\x3E\x5F\x74\x69\x7E\x7F\x58\x7F\x73\x3F\x5C\xC4\x57\xAA\x00\x17\x08\x11\x47\x74\x69\x7E\x7E\x58\x7F\x72\x3F\x5E\x75\x68\x7F\x7E\x59\x7E\x72\x3E\x5D\xC5\x56\xAA\x00\x08\x11\x12\x5C\x77\x76\x9E\x7C\x5B\xAA\x00\x17\x08\x13\x45\x76\x6B\x7C\x7C\x5A\x7D\x70\x3D\x5C\x77\x6A\x7D\x7C\x5B\x7C\x70\x3C\x5F\xC7\x54")
  end

  def receive_data data
    parse_packet TkPacket.parse_char(data)
  end
 
end

 EventMachine::run {
   EventMachine::start_server HOST, PORT, TkGameServer
   puts 'Running TKServer [Game]'
 }